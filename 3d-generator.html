<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Model Generator - ArtSpace</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2311998e' rx='15' width='100' height='100'/><text y='.9em' x='50%' text-anchor='middle' font-size='70'>üé®</text></svg>">
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .hero {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .hero h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .hero p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            border-color: #11998e;
            background: linear-gradient(135deg, rgba(17,153,142,0.1) 0%, rgba(56,239,125,0.1) 100%);
        }
        
        .tab-btn span {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Camera Section */
        .camera-section {
            text-align: center;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            display: none;
        }
        
        .video-container.active {
            display: block;
        }
        
        #camera-video {
            width: 100%;
            display: block;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-frame {
            width: 80%;
            height: 80%;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 10px;
        }
        
        /* Simple Buttons - No nested elements */
        .btn {
            display: inline-block;
            padding: 15px 30px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: transform 0.2s, opacity 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            color: white;
        }
        
        /* CAPTURE BUTTON - Simple design, no nested elements */
        #capture-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 5px solid #e94560;
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            cursor: pointer;
            margin: 20px auto;
            display: block;
            -webkit-tap-highlight-color: transparent;
            -webkit-appearance: none;
            appearance: none;
        }
        
        #capture-btn:active {
            transform: scale(0.9);
            opacity: 0.8;
        }
        
        .camera-controls {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .camera-controls.active {
            display: flex;
        }
        
        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .image-slot {
            aspect-ratio: 1;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            font-size: 1.5rem;
            color: #ccc;
        }
        
        .image-slot.filled {
            border-style: solid;
            border-color: #11998e;
        }
        
        .image-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-slot .remove {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 24px;
            height: 24px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .upload-area:active {
            background: #f5f5f5;
        }
        
        .upload-area span {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }
        
        /* GLB Upload */
        .glb-upload {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .glb-upload:active {
            background: #f5f5f5;
        }
        
        .glb-upload span {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }
        
        /* Options */
        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .option-row:last-child {
            border-bottom: none;
        }
        
        .option-label {
            font-weight: 500;
        }
        
        .option-desc {
            font-size: 0.85rem;
            color: #888;
        }
        
        /* Toggle Switch */
        .toggle {
            width: 50px;
            height: 28px;
            background: #ddd;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle.on {
            background: #11998e;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle.on::after {
            transform: translateX(22px);
        }
        
        /* Progress */
        .progress-section {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .progress-section.active {
            display: block;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            width: 0%;
            transition: width 0.5s;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #eee;
            border-top-color: #11998e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Result */
        .result-section {
            display: none;
        }
        
        .result-section.active {
            display: block;
        }
        
        .upload-to-gallery {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }
        
        .gallery-upload-area {
            border: 2px dashed #ccc;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .gallery-upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .gallery-upload-area .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .download-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Gallery Form */
        .gallery-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .gallery-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        /* Error */
        .error-msg {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .error-msg.active {
            display: block;
        }
        
        /* Tips */
        .tips {
            background: #e8f5e9;
            border-radius: 15px;
            padding: 20px;
        }
        
        .tips h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .tips ul {
            margin-left: 20px;
            color: #555;
        }
        
        .tips li {
            margin-bottom: 5px;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Image count badge */
        .image-count {
            background: #11998e;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">
            <div class="logo-icon">üé®</div>
            3D Generator
        </a>
        <a href="index.html" class="back-btn">‚Üê Back to Gallery</a>
    </header>
    
    <div class="container">
        <div class="hero">
            <h1>Turn Photos into 3D Models</h1>
            <p>Capture up to 4 images from different angles for better results</p>
        </div>
        
        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('generate')">
                    <span>üì∏</span>
                    Generate 3D
                </button>
                <button class="tab-btn" onclick="switchTab('import')">
                    <span>üì¶</span>
                    Import Model
                </button>
            </div>
            
            <!-- Generate Tab -->
            <div id="tab-generate" class="tab-content active">
                <div class="camera-section">
                    <!-- Start Camera Button -->
                    <button id="start-camera-btn" class="btn btn-primary" onclick="startCamera()">
                        üì∑ Start Camera
                    </button>
                    
                    <!-- Video Container -->
                    <div id="video-container" class="video-container">
                        <video id="camera-video" autoplay playsinline muted></video>
                        <div class="video-overlay">
                            <div class="video-frame"></div>
                        </div>
                    </div>
                    
                    <!-- Capture Button - SIMPLE, NO NESTED ELEMENTS -->
                    <button id="capture-btn" class="hidden" onclick="capturePhoto()"></button>
                    
                    <!-- Camera Controls -->
                    <div id="camera-controls" class="camera-controls">
                        <button class="btn btn-secondary" onclick="switchCamera()">üîÑ Switch</button>
                        <button class="btn btn-secondary" onclick="stopCamera()">‚úï Close</button>
                    </div>
                </div>
                
                <!-- Image Grid -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>üì∑ Captured Images</strong>
                        <span id="image-count" class="image-count">0/4</span>
                    </div>
                    <div id="image-grid" class="image-grid">
                        <div class="image-slot" onclick="triggerUpload()">+</div>
                        <div class="image-slot" onclick="triggerUpload()">+</div>
                        <div class="image-slot" onclick="triggerUpload()">+</div>
                        <div class="image-slot" onclick="triggerUpload()">+</div>
                    </div>
                </div>
                
                <!-- Upload Area -->
                <div class="upload-area" onclick="triggerUpload()">
                    <span>üìÅ</span>
                    <p>Tap to upload images</p>
                    <p style="font-size: 0.85rem; color: #888;">JPG, PNG (up to 4)</p>
                </div>
                <input type="file" id="file-input" accept="image/*" multiple style="display: none;" onchange="handleFiles(this.files)">
            </div>
            
            <!-- Import Tab -->
            <div id="tab-import" class="tab-content">
                <div class="glb-upload" onclick="document.getElementById('glb-input').click()">
                    <span>üì¶</span>
                    <p>Tap to upload GLB/GLTF file</p>
                </div>
                <input type="file" id="glb-input" accept=".glb,.gltf" style="display: none;" onchange="handleGLB(this.files[0])">
            </div>
        </div>
        
        <!-- Options Card -->
        <div id="options-card" class="card">
            <h3>‚öôÔ∏è Generation Options</h3>
            <div class="option-row">
                <div>
                    <div class="option-label">Generate Textures</div>
                    <div class="option-desc">Add realistic textures</div>
                </div>
                <div id="toggle-texture" class="toggle on" onclick="toggleOption(this)"></div>
            </div>
            <div class="option-row">
                <div>
                    <div class="option-label">PBR Maps</div>
                    <div class="option-desc">Metallic, roughness, normal</div>
                </div>
                <div id="toggle-pbr" class="toggle on" onclick="toggleOption(this)"></div>
            </div>
            
            <button id="generate-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="generateModel()" disabled>
                Generate 3D Model
            </button>
        </div>
        
        <!-- Progress Section -->
        <div id="progress-section" class="card progress-section">
            <div class="spinner"></div>
            <h3 id="progress-text">Creating your 3D model...</h3>
            <p id="progress-status" style="color: #888; margin-top: 10px;">This may take 2-5 minutes</p>
            <div class="progress-bar-bg">
                <div id="progress-bar" class="progress-bar-fill"></div>
            </div>
            <p id="progress-percent">0%</p>
        </div>
        
        <!-- Error Message -->
        <div id="error-msg" class="error-msg"></div>
        
        <!-- Result Section -->
        <div id="result-section" class="card result-section">
            <h3>üéâ Your 3D Model is Ready!</h3>
            <p style="color: #666; margin-bottom: 20px;">Download your 3D model file below, then upload it to add to your gallery.</p>
            
            <div class="download-btns">
                <a id="download-glb" class="btn btn-primary" download>üì• Download GLB File</a>
                <a id="download-fbx" class="btn btn-secondary" download>üì• Download FBX</a>
                <a id="download-obj" class="btn btn-secondary" download>üì• Download OBJ</a>
            </div>
            
            <div class="upload-to-gallery">
                <h4>üì§ Upload to Gallery</h4>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">After downloading, upload the GLB file here to add it to your gallery and view in AR.</p>
                
                <div class="gallery-upload-area" id="gallery-upload-area" onclick="document.getElementById('gallery-file-input').click()">
                    <input type="file" id="gallery-file-input" accept=".glb,.gltf" style="display: none;" onchange="handleGalleryUpload(event)">
                    <div class="upload-icon">üìÅ</div>
                    <p>Click to upload GLB file</p>
                    <span style="color: #888; font-size: 0.85rem;">or drag and drop</span>
                </div>
                
                <div id="uploaded-file-info" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                    <p style="color: #2e7d32; font-weight: 600;">‚úÖ File uploaded: <span id="uploaded-file-name"></span></p>
                </div>
                
                <input type="text" id="model-title" placeholder="Model title" style="margin-top: 15px;">
                <input type="text" id="model-artist" placeholder="Artist name (optional)">
                <button class="btn btn-primary" style="width: 100%;" onclick="addUploadedToGallery()" id="add-gallery-btn" disabled>
                    Add to Gallery
                </button>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="resetPage()">
                + Create Another Model
            </button>
        </div>
        
        <!-- Tips -->
        <div class="tips">
            <h4>üí° Tips for Best Results</h4>
            <ul>
                <li>Take 2-4 photos from different angles</li>
                <li>Use a plain, contrasting background</li>
                <li>Ensure good, even lighting</li>
                <li>Avoid reflective or transparent objects</li>
            </ul>
        </div>
    </div>
    
    <script>
        // Meshy.ai API
        const API_KEY = 'msy_lzjCzq1NuuNTcdypfDc4LqX4fcVbHxeilx05';
        const API_BASE = 'https://api.meshy.ai/openapi/v1';
        
        // State
        let stream = null;
        let facingMode = 'environment';
        let images = [];
        let taskId = null;
        let pollTimer = null;
        let modelUrls = null;
        
        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }
        
        // Toggle option
        function toggleOption(el) {
            el.classList.toggle('on');
        }
        
        // Start camera
        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                }
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                
                document.getElementById('camera-video').srcObject = stream;
                document.getElementById('video-container').classList.add('active');
                document.getElementById('capture-btn').classList.remove('hidden');
                document.getElementById('camera-controls').classList.add('active');
                document.getElementById('start-camera-btn').classList.add('hidden');
                
            } catch (err) {
                showError('Camera access denied. Please allow camera access.');
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            document.getElementById('video-container').classList.remove('active');
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('camera-controls').classList.remove('active');
            document.getElementById('start-camera-btn').classList.remove('hidden');
        }
        
        // Switch camera
        async function switchCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            await startCamera();
        }
        
        // CAPTURE PHOTO - Simple function
        function capturePhoto() {
            console.log('capturePhoto called');
            
            if (images.length >= 4) {
                showError('Maximum 4 images. Remove one to add more.');
                return;
            }
            
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            images.push(dataUrl);
            updateImageGrid();
            
            console.log('Photo captured, total images:', images.length);
        }
        
        // Trigger file upload
        function triggerUpload() {
            document.getElementById('file-input').click();
        }
        
        // Handle uploaded files
        function handleFiles(files) {
            console.log('handleFiles called with', files.length, 'files');
            
            const remaining = 4 - images.length;
            const toProcess = Array.from(files).slice(0, remaining);
            
            toProcess.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    images.push(e.target.result);
                    updateImageGrid();
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Update image grid
        function updateImageGrid() {
            const grid = document.getElementById('image-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const slot = document.createElement('div');
                slot.className = 'image-slot' + (images[i] ? ' filled' : '');
                
                if (images[i]) {
                    slot.innerHTML = `
                        <img src="${images[i]}" alt="Image ${i+1}">
                        <button class="remove" onclick="removeImage(${i}, event)">√ó</button>
                    `;
                } else {
                    slot.textContent = '+';
                    slot.onclick = triggerUpload;
                }
                
                grid.appendChild(slot);
            }
            
            document.getElementById('image-count').textContent = images.length + '/4';
            document.getElementById('generate-btn').disabled = images.length === 0;
        }
        
        // Remove image
        function removeImage(index, event) {
            event.stopPropagation();
            images.splice(index, 1);
            updateImageGrid();
        }
        
        // Handle GLB upload (Import tab)
        function handleGLB(file) {
            if (!file) return;
            
            const url = URL.createObjectURL(file);
            
            // Show result section
            document.getElementById('options-card').classList.add('hidden');
            document.getElementById('progress-section').classList.remove('active');
            document.getElementById('result-section').classList.add('active');
            
            // Set download link
            document.getElementById('download-glb').href = url;
            document.getElementById('download-fbx').style.display = 'none';
            document.getElementById('download-obj').style.display = 'none';
            
            // Auto-fill the gallery upload area
            uploadedModelBlob = url;
            document.getElementById('uploaded-file-name').textContent = file.name;
            document.getElementById('uploaded-file-info').style.display = 'block';
            document.getElementById('add-gallery-btn').disabled = false;
            
            // Auto-fill title from filename
            const titleInput = document.getElementById('model-title');
            if (!titleInput.value) {
                titleInput.value = file.name.replace(/\.(glb|gltf)$/i, '');
            }
            
            // Scroll to result
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Generate 3D model
        async function generateModel() {
            if (images.length === 0) {
                showError('Please add at least one image');
                return;
            }
            
            const shouldTexture = document.getElementById('toggle-texture').classList.contains('on');
            const enablePbr = document.getElementById('toggle-pbr').classList.contains('on');
            
            // Show progress
            document.getElementById('options-card').classList.add('hidden');
            document.getElementById('progress-section').classList.add('active');
            
            try {
                // Use multi-image API if more than 1 image
                const endpoint = images.length > 1 ? '/multi-image-to-3d' : '/image-to-3d';
                
                let body;
                if (images.length > 1) {
                    body = {
                        image_urls: images,
                        should_texture: shouldTexture,
                        enable_pbr: enablePbr
                    };
                } else {
                    body = {
                        image_url: images[0],
                        should_texture: shouldTexture,
                        enable_pbr: enablePbr,
                        ai_model: 'meshy-6'
                    };
                }
                
                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API error');
                }
                
                taskId = data.result;
                pollStatus();
                
            } catch (err) {
                showError('Error: ' + err.message);
                resetProgress();
            }
        }
        
        // Poll task status
        async function pollStatus() {
            try {
                const endpoint = images.length > 1 ? '/multi-image-to-3d/' : '/image-to-3d/';
                const response = await fetch(API_BASE + endpoint + taskId, {
                    headers: { 'Authorization': 'Bearer ' + API_KEY }
                });
                
                const data = await response.json();
                
                const progress = data.progress || 0;
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-percent').textContent = progress + '%';
                document.getElementById('progress-status').textContent = data.status || 'Processing...';
                
                if (data.status === 'SUCCEEDED') {
                    const glbUrl = data.model_urls?.glb || data.model_url;
                    const fbxUrl = data.model_urls?.fbx;
                    const objUrl = data.model_urls?.obj;
                    showResult(glbUrl, fbxUrl, objUrl, 'generated');
                } else if (data.status === 'FAILED') {
                    throw new Error(data.task_error?.message || 'Generation failed');
                } else {
                    pollTimer = setTimeout(pollStatus, 3000);
                }
                
            } catch (err) {
                showError('Error: ' + err.message);
                resetProgress();
            }
        }
        
        // Show result
        function showResult(glbUrl, fbxUrl, objUrl, type) {
            console.log('showResult called with:', glbUrl);
            
            document.getElementById('progress-section').classList.remove('active');
            document.getElementById('result-section').classList.add('active');
            
            // Store URLs for download
            modelUrls = { glb: glbUrl, fbx: fbxUrl, obj: objUrl, type: type };
            
            // Set download links
            document.getElementById('download-glb').href = glbUrl;
            
            if (fbxUrl) {
                document.getElementById('download-fbx').href = fbxUrl;
                document.getElementById('download-fbx').style.display = 'block';
            } else {
                document.getElementById('download-fbx').style.display = 'none';
            }
            
            if (objUrl) {
                document.getElementById('download-obj').href = objUrl;
                document.getElementById('download-obj').style.display = 'block';
            } else {
                document.getElementById('download-obj').style.display = 'none';
            }
            
            // Reset upload area
            document.getElementById('uploaded-file-info').style.display = 'none';
            document.getElementById('add-gallery-btn').disabled = true;
            uploadedModelBlob = null;
            
            // Scroll to result
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Uploaded model storage - stores Base64 data URL for persistence
        let uploadedModelData = null;
        let uploadedModelPreviewUrl = null;
        
        // Handle gallery upload - converts file to Base64 for localStorage persistence
        function handleGalleryUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(glb|gltf)$/i)) {
                showError('Please upload a GLB or GLTF file');
                return;
            }
            
            // Create preview URL for immediate display
            uploadedModelPreviewUrl = URL.createObjectURL(file);
            
            // Convert file to Base64 data URL for persistent storage
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedModelData = e.target.result; // This is a data:application/octet-stream;base64,... URL
                document.getElementById('uploaded-file-name').textContent = file.name;
                document.getElementById('uploaded-file-info').style.display = 'block';
                document.getElementById('add-gallery-btn').disabled = false;
                
                // Auto-fill title from filename
                const titleInput = document.getElementById('model-title');
                if (!titleInput.value) {
                    titleInput.value = file.name.replace(/\.(glb|gltf)$/i, '');
                }
            };
            reader.onerror = function() {
                showError('Failed to read file. Please try again.');
            };
            reader.readAsDataURL(file);
        }
        
        // Add uploaded file to gallery
        function addUploadedToGallery() {
            if (!uploadedModelData) {
                showError('Please upload a GLB file first');
                return;
            }
            
            const title = document.getElementById('model-title').value || 'Untitled Model';
            const artist = document.getElementById('model-artist').value || 'Unknown Artist';
            
            // Determine if this is from Meshy generation or import
            const isFromMeshy = uploadedModelData.includes('meshy') || (typeof uploadedModelData === 'string' && uploadedModelData.startsWith('http'));
            const badgeText = isFromMeshy ? 'AI Generated' : 'Imported';
            
            const artwork = {
                id: Date.now(),
                title: title,
                artist: artist,
                type: '3d',
                model: uploadedModelData, // Now stores Base64 data URL for persistence
                image: '',
                badge: badgeText,
                category: 'sculpture',
                style: 'Digital',
                medium: '3D Model',
                price: 'Custom',
                dimensions: {
                    width: 20,
                    height: 20,
                    depth: 20
                },
                tags: ['3d', 'custom', 'user-uploaded', badgeText.toLowerCase().replace(' ', '-')],
                source: badgeText,
                addedAt: new Date().toISOString()
            };
            
            try {
                const saved = JSON.parse(localStorage.getItem('artspace_user_artworks') || '[]');
                saved.push(artwork);
                localStorage.setItem('artspace_user_artworks', JSON.stringify(saved));
                
                alert('‚úÖ Added to gallery! Go back to see your model.');
                
                // Reset
                document.getElementById('uploaded-file-info').style.display = 'none';
                document.getElementById('add-gallery-btn').disabled = true;
                document.getElementById('model-title').value = '';
                document.getElementById('model-artist').value = '';
                uploadedModelData = null;
                if (uploadedModelPreviewUrl) {
                    URL.revokeObjectURL(uploadedModelPreviewUrl);
                    uploadedModelPreviewUrl = null;
                }
            } catch (err) {
                console.error('Error saving to gallery:', err);
                if (err.name === 'QuotaExceededError') {
                    showError('Storage full! Please delete some artworks or use a smaller model file.');
                } else {
                    showError('Failed to save to gallery: ' + err.message);
                }
            }
        }
        
        // Drag and drop for gallery upload
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('gallery-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#10b981';
                    uploadArea.style.background = '#f0fdf4';
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = '#ccc';
                    uploadArea.style.background = '#fafafa';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ccc';
                    uploadArea.style.background = '#fafafa';
                    
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        document.getElementById('gallery-file-input').files = e.dataTransfer.files;
                        handleGalleryUpload({ target: { files: [file] } });
                    }
                });
            }
        });
        
        // Show error
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 5000);
        }
        
        // Reset progress
        function resetProgress() {
            document.getElementById('progress-section').classList.remove('active');
            document.getElementById('options-card').classList.remove('hidden');
        }
        
        // Reset page
        function resetPage() {
            images = [];
            taskId = null;
            modelUrls = null;
            if (pollTimer) clearTimeout(pollTimer);
            
            updateImageGrid();
            document.getElementById('result-section').classList.remove('active');
            document.getElementById('progress-section').classList.remove('active');
            document.getElementById('options-card').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-percent').textContent = '0%';
        }
        
        // Initialize
        updateImageGrid();
    </script>
</body>
</html>
